<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Basement Escape — AR Experience</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />

  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

  <style>
    body { margin:0; overflow:hidden; background:black; }
    #hintBox {
      position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
      background:rgba(0,0,0,0.75); color:#fff; padding:10px 15px;
      border-radius:10px; max-width:320px; text-align:center;
      font-family:sans-serif; font-size:14px; z-index:9999;
    }
    #debugMobile {
      position:fixed; top:10px; left:10px;
      background:rgba(0,0,0,0.6); color:#fff;
      padding:6px 10px; font-size:14px; z-index:99999;
    }
    #uiButtons {
      position:fixed; bottom:80px; left:50%; transform:translateX(-50%);
      display:flex; flex-direction:column; gap:8px;
      z-index:99999;
    }
    #uiButtons button {
      padding:10px 14px;
      font-size:14px; border:0; border-radius:8px;
      background:rgba(255,255,255,0.85);
      cursor:pointer;
    }
    #timerBox {
      position:fixed; top:10px; right:10px;
      background:red; padding:8px 12px; color:white;
      font-size:18px; font-weight:bold; border-radius:6px;
      display:none; z-index:9999;
      
    }
  </style>
</head>

<body>

<div id="debugMobile">DEBUG: none</div>
<div id="hintBox">The basement waits… Scan the Flashlight.</div>
<div id="timerBox">5</div>

<div id="uiButtons"></div>
<div id="codeUI" 
     style="display:none; position:fixed; top:50%; left:50%;
            transform:translate(-50%, -50%);
            background:rgba(0,0,0,0.9); color:white;
            padding:20px; border-radius:12px; text-align:center;
            z-index:99999; width:260px;">
  <div style="margin-bottom:10px;" id="codeMessage">Enter code:</div>
  <input id="codeInput" maxlength="4"
         style="width:120px; font-size:20px; padding:5px; text-align:center;">
  <br><br>
  <button id="codeSubmit"
          style="padding:8px 14px; font-size:14px;">Submit</button>
  <div id="codeTimer" style="margin-top:10px; font-size:12px; opacity:0.7;">
    10s remaining
  </div>
</div>


<a-scene embedded arjs="trackingMethod: best;">
  <a-entity light="type: ambient; intensity: 0.7"></a-entity>
  <a-entity light="type: directional; intensity: 0.6" position="0 1 1"></a-entity>

  <!-- FLASHLIGHT -->
  <a-nft id="m_flashlight" type="nft" url="markers/flashlight">
    <a-entity id="flashlight" gltf-model="models/flashlight/scene.gltf"
      scale="0.3 0.3 0.3" visible="false"></a-entity>
  </a-nft>

  <!-- FUSE BOX -->
  <a-nft id="m_fusebox" type="nft" url="markers/fuse_box">
    <a-entity id="fusebox" gltf-model="models/fusebox/scene.gltf"
      scale="0.35 0.35 0.35" visible="false"></a-entity>
  </a-nft>

  <!-- NOTEBOOK -->
  <a-nft id="m_notebook" type="nft" url="markers/notebook">
    <a-entity id="notebook" gltf-model="models/notebook/scene.gltf"
      scale="0.35 0.35 0.35" visible="false"></a-entity>
  </a-nft>

  <!-- LOCKER -->
  <a-nft id="m_locker" type="nft" url="markers/locker">
    <a-entity id="locker" gltf-model="models/rusty_locker/scene.gltf"
      scale="0.45 0.45 0.45" visible="false"></a-entity>
  </a-nft>

  <!-- VENT -->
  <a-nft id="m_vent" type="nft" url="markers/vent">
    <a-entity id="vent" gltf-model="models/vent/scene.gltf"
      scale="0.40 0.40 0.40" visible="false"></a-entity>
  </a-nft>

  <!-- DOOR -->
  <a-nft id="m_door" type="nft" url="markers/door">
    <a-entity id="door" gltf-model="models/door/scene.gltf"
      scale="1 1 1" visible="false"></a-entity>
  </a-nft>

  <!-- RADIO (secret branch) -->
  <a-nft id="m_radio" type="nft" url="markers/radio">
    <a-entity id="radio" gltf-model="models/radio/scene.gltf"
      scale="0.4 0.4 0.4" visible="false"></a-entity>
  </a-nft>

  <a-entity camera></a-entity>
</a-scene>

<script>
/* -----------------------------
   STATE
------------------------------ */

let state = "start";
let fuseOn = false;
let notebookChoice = null;   // "locker" or "radio"
let keyFound = false;
let ventOpen = false;
let radioTuned = false;

let timer = 0;
let timerInterval = null;
let lockerCode = "4729";     
let codeTimerInterval = null;
let timeLeft = 10;
let notebookRead = false;


/* -----------------------------
   HELPERS
------------------------------ */

function debug(msg){
  document.getElementById("debugMobile").innerText = "DEBUG: " + msg;
}
function hint(msg){
  document.getElementById("hintBox").innerText = msg;
}
function showButtons(...btns){
  const box = document.getElementById("uiButtons");
  box.innerHTML = "";
  btns.forEach(b => box.appendChild(b));
}
function clearButtons(){
  document.getElementById("uiButtons").innerHTML = "";
}

/* -----------------------------
   TIMER
------------------------------ */
function startTimer(seconds, onEnd){
  const box = document.getElementById("timerBox");
  timer = seconds;
  box.style.display = "block";
  box.innerText = timer;

  timerInterval = setInterval(()=>{
    timer--;
    box.innerText = timer;
    if(timer <= 0){
      clearInterval(timerInterval);
      box.style.display = "none";
      onEnd();
    }
  },1000);
}

/* -----------------------------
   MARKERS
------------------------------ */

const M = {
  flash: m_flashlight,
  fuse: m_fusebox,
  note: m_notebook,
  locker: m_locker,
  vent: m_vent,
  door: m_door,
  radio: m_radio
};

const E = {
  flash: flashlight,
  fuse: fusebox,
  note: notebook,
  locker: locker,
  vent: vent,
  door: door,
  radio: radio
};

function showCodeButton() {
  const hintBox = document.getElementById("hintBox");
  hintBox.innerHTML += "<br><button id='enterCodeBtn' style='margin-top:8px; padding:6px 12px;'>ENTER CODE</button>";

  document.getElementById("enterCodeBtn").onclick = () => {
    openCodeUI();
  };
}

function openCodeUI() {
  const ui = document.getElementById("codeUI");
  const timerEl = document.getElementById("codeTimer");
  const input = document.getElementById("codeInput");
  const msg = document.getElementById("codeMessage");

  input.value = "";
  ui.style.display = "block";
  timeLeft = 10;
  timerEl.innerText = `${timeLeft}s remaining`;

  codeTimerInterval = setInterval(() => {
    timeLeft--;
    timerEl.innerText = `${timeLeft}s remaining`;

    if (timeLeft <= 0) {
      clearInterval(codeTimerInterval);
      msg.innerText = "Time’s up! Re-scan Notebook to retry.";
      setTimeout(() => ui.style.display = "none", 1500);
    }
  }, 1000);

  document.getElementById("codeSubmit").onclick = () => {
    if (input.value === lockerCode) {
      clearInterval(codeTimerInterval);
      ui.style.display = "none";
      lockerOpened = true;
      state = "locker";
      hint("The code clicks. The Locker is now open — scan it.");
    } else {
      msg.innerText = "Wrong code! Try again.";
    }
  };
}


/* -----------------------------
   FLASHLIGHT
------------------------------ */
M.flash.addEventListener("markerFound",()=>{
  E.flash.setAttribute("visible",true);
  if(state==="start"){
    state="flashlight";
    hint("The beam flickers alive… Find the Fuse Box.");
  }
});
M.flash.addEventListener("markerLost",()=>E.flash.setAttribute("visible",false));

/* -----------------------------
   FUSE BOX
------------------------------ */
M.fuse.addEventListener("markerFound",()=>{
  E.fuse.setAttribute("visible",true);

  if(state!=="flashlight"){
    hint("Too dark. Restore light first.");
    return;
  }

  if(!fuseOn){
    fuseOn=true;
    hint("Power surges back. Find the Notebook.");
    state="fuse";
  }
});
M.fuse.addEventListener("markerLost",()=>E.fuse.setAttribute("visible",false));

/* -----------------------------
   NOTEBOOK (with code unlock)
------------------------------ */
M.note.addEventListener("markerFound", () => {
  E.note.setAttribute("visible", true);

  if (!fuseOn) {
    hint("The notebook is unreadable in the dark… Fix the Fuse Box first.");
    return;
  }

  if (!notebookRead) {
  notebookRead = true;
  state = "note";

  hint("A torn page reveals two clues. Pick a path:");

  clearButtons();

  // Button 1: Locker branch
  const b1 = document.createElement("button");
  b1.innerText = "Follow the Locker Clue";
  b1.onclick = () => {
    notebookChoice = "locker";
    hint("You chose the Locker path. Press ENTER CODE.");
    clearButtons();
    showCodeButton();
  };

  // Button 2: Radio branch
  const b2 = document.createElement("button");
  b2.innerText = "Follow the Radio Signal";
  b2.onclick = () => {
    notebookChoice = "radio";
    hint("You chose the Radio path. Scan the Radio.");
    clearButtons();
  };

  showButtons(b1, b2);
}

});

M.note.addEventListener("markerLost", () => {
  E.note.setAttribute("visible", false);
});



/* -----------------------------
   LOCKER
------------------------------ */
M.locker.addEventListener("markerFound",()=>{
  E.locker.setAttribute("visible",true);

  if(notebookChoice!=="locker"){
    hint("The lock resists. Something else guides you.");
    return;
  }

  if(!keyFound){
    hint("Enter the code before time runs out!");

    const btn = document.createElement("button");
    btn.innerText="Enter Code";
    btn.onclick=()=>{
      keyFound=true;
      clearButtons();
      hint("Key found. The Door may open.");
    };

    showButtons(btn);

    // TIME LIMIT
    startTimer(5,()=>{
      clearButtons();
      hint("You failed. The locker jams permanently.");
    });
  }
});
M.locker.addEventListener("markerLost",()=>E.locker.setAttribute("visible",false));

/* -----------------------------
   VENT
------------------------------ */
M.vent.addEventListener("markerFound",()=>{
  E.vent.setAttribute("visible",true);

  if(!keyFound){
    hint("Screws are tight… Something else might remove them.");
    return;
  }

  if(!ventOpen){
    ventOpen=true;
    hint("Vent loosens… You can escape if the Door fails.");
  }
});
M.vent.addEventListener("markerLost",()=>E.vent.setAttribute("visible",false));

/* -----------------------------
   RADIO (Secret Ending)
------------------------------ */
let frequency = 90;
M.radio.addEventListener("markerFound",()=>{
  E.radio.setAttribute("visible",true);

  if(notebookChoice!=="radio"){
    hint("Static. Wrong path.");
    return;
  }

  hint("Tune the radio…");

  const btn = document.createElement("button");
  btn.innerText="Tune (+5 MHz)";
  btn.onclick=()=>{
    frequency += 5;

    if(frequency >= 105){
      radioTuned=true;
      hint("A voice whispers: 'The exit awaits…'");
      clearButtons();
    } else {
      hint("Frequency: "+frequency+" MHz");
    }
  };

  showButtons(btn);
});
M.radio.addEventListener("markerLost",()=>E.radio.setAttribute("visible",false));

/* -----------------------------
   DOOR — Multiple Endings
------------------------------ */
M.door.addEventListener("markerFound",()=>{
  E.door.setAttribute("visible",true);

  if(!fuseOn){
    hint("No power. Door won't respond.");
    return;
  }

  // SECRET ENDING
  if(radioTuned){
    hint("The door opens on its own. You escaped the strange signal.");
    clearButtons();
    return;
  }

  // NORMAL ENDING
  if(keyFound){
    const btn = document.createElement("button");
    btn.innerText="Use Key";
    btn.onclick=()=>{
      hint("The lock clicks. You escaped the basement.");
      clearButtons();
    };
    showButtons(btn);
    return;
  }

  // VENT ENDING
  if(ventOpen){
    hint("Door stuck. But the vent is open — escape through it.");
    clearButtons();
    return;
  }

  hint("The door is locked tight.");
});
M.door.addEventListener("markerLost",()=>E.door.setAttribute("visible",false));

</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Basement Escape — AR Experience</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />

  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.4/aframe/build/aframe-ar-nft.js"></script>

  <style>
    body { margin:0; overflow:hidden; background:black; }
    #hintBox {
      position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
      background:rgba(0,0,0,0.75); color:#fff; padding:10px 15px;
      border-radius:10px; max-width:320px; text-align:center;
      font-family:sans-serif; font-size:14px; z-index:9999;
    }
    #debugMobile {
      position:fixed; top:10px; left:10px;
      background:rgba(0,0,0,0.6); color:#fff;
      padding:6px 10px; font-size:14px; z-index:99999;
    }
    #uiButtons {
      position:fixed; bottom:120px; left:50%; transform:translateX(-50%);
      display:flex; flex-direction:column; gap:10px;
      z-index:99999;
    }
    #uiButtons button,
    #codeSubmit,
    #enterCodeBtn {
    padding:12px 16px;
    font-size:14px;
    border:1px solid rgba(255,255,255,0.3);
    border-radius:8px;
    background:rgba(15,15,15,0.9);
    color:#eee;
    cursor:pointer;
    backdrop-filter:blur(4px);
  }
     #timerBox {
    position:fixed;
    top:15px; right:15px;
    background:rgba(120,0,0,0.85);
    padding:8px 12px;
    color:white;
    font-size:18px;
    font-weight:bold;
    border-radius:6px;
    border:1px solid rgba(255,255,255,0.15);
    display:none;
    z-index:9999;
  }
  #codeUI {
    display:none;
    position:fixed;
    top:50%; left:50%;
    transform:translate(-50%, -50%);
    background:rgba(0,0,0,0.9);
    color:white;
    padding:25px;
    border-radius:12px;
    width:260px;
    text-align:center;
    border:1px solid rgba(255,255,255,0.25);
    backdrop-filter:blur(8px);
    z-index:99999;
  }

  #codeInput {
    width:130px;
    font-size:22px;
    padding:6px;
    text-align:center;
    background:black;
    color:white;
    border:1px solid rgba(255,255,255,0.3);
    border-radius:6px;
  }

  /* Slider (radio) */
  #radioSlider {
    display:none;
    position:fixed;
    bottom:200px;    /* lifted up from 150px -> 200px */
    left:50%;
    transform:translateX(-50%);
    width:260px;
    height:30px;
    z-index:999999;

    /* Dark slider style */
    -webkit-appearance:none;
    appearance:none;
    background:#111;
    border:1px solid rgba(255,255,255,0.25);
    border-radius:10px;
  }

  #radioSlider::-webkit-slider-thumb {
    -webkit-appearance:none;
    width:22px;
    height:22px;
    background:#fff;
    border-radius:50%;
    border:2px solid #444;
    cursor:pointer;
  }
  #radioSlider::-moz-range-thumb {
    width:22px;
    height:22px;
    background:#fff;
    border-radius:50%;
    border:2px solid #444;
    cursor:pointer;
  }
  </style>
</head>

<body>

<div id="debugMobile">DEBUG: none</div>
<div id="hintBox">The basement waits… Scan the Flashlight.</div>
<div id="timerBox">5</div>

<div id="uiButtons"></div>
<div id="codeUI" 
     style="display:none; position:fixed; top:50%; left:50%;
            transform:translate(-50%, -50%);
            background:rgba(0,0,0,0.9); color:white;
            padding:20px; border-radius:12px; text-align:center;
            z-index:99999; width:260px;">
  <div style="margin-bottom:10px;" id="codeMessage">Enter code:</div>
  <input id="codeInput" maxlength="4"
         style="width:120px; font-size:20px; padding:5px; text-align:center;">
  <br><br>
  <button id="codeSubmit"
          style="padding:8px 14px; font-size:14px;">Submit</button>
  <div id="codeTimer" style="margin-top:10px; font-size:12px; opacity:0.7;">
    10s remaining
  </div>
</div>
<input type="range" id="radioSlider"
       min="80" max="120" value="90"
       style="
         display:none;
         position:fixed;
         bottom:150px;
         left:50%;
         transform:translateX(-50%);
         width:250px;
         height:30px;
         z-index:999999;
       ">

<div id="gameOverScreen"
     style="display:none; position:fixed; top:0; left:0;
            right:0; height:100dvh;
            background:black; color:white;
            font-family:sans-serif;
            font-size:32px; font-weight:bold;
            flex-direction:column;
            align-items:center; justify-content:center;
            padding:20px; /* prevents text touching edges */

            z-index:100000;">
  GAME OVER
  <div style="font-size:16px; margin-top:10px; opacity:0.7;">
    Your choices led to a dead end.<br>Refresh to try again.
  </div>
</div>

<div id="winScreen"
     style="display:none; position:fixed; top:0; left:0;
            right:0; height:100dvh;
            background:black; color:white;
            font-family:sans-serif;
            font-size:32px; font-weight:bold;
            flex-direction:column;
            align-items:center; justify-content:center;
            padding:20px; /* prevents text touching edges */
            z-index:100000;">
  YOU ESCAPED
  <div style="font-size:16px; margin-top:10px; opacity:0.7;">
    You found your way out.<br>Refresh to play again





<a-scene embedded arjs="trackingMethod: best;">
  <a-entity light="type: ambient; intensity: 0.7"></a-entity>
  <a-entity light="type: directional; intensity: 0.6" position="0 1 1"></a-entity>

  <!-- FLASHLIGHT -->
  <a-nft id="m_flashlight" type="nft" url="markers/flashlight">
    <a-entity id="flashlight" gltf-model="models/flashlight/scene.gltf"
    scale="1000 1000 1000" position="0 0 0" visible="false"></a-entity>
  </a-nft>

  <!-- FUSE BOX -->
  <a-nft id="m_fusebox" type="nft" url="markers/fuse_box">
    <a-entity id="fusebox" gltf-model="models/fusebox/scene.gltf"
      scale="5 5 5" visible="false"></a-entity>
  </a-nft>

  <!-- NOTEBOOK -->
  <a-nft id="m_notebook" type="nft" url="markers/notebook">
    <a-entity id="notebook" gltf-model="models/notebook/scene.gltf"
      scale="15 15 15" visible="false"></a-entity>
  </a-nft>

  <!-- LOCKER -->
  <a-nft id="m_locker" type="nft" url="markers/locker">
    <a-entity id="locker" gltf-model="models/rusty_locker/scene.gltf"
      scale="0.45 0.45 0.45" visible="false"></a-entity>
  </a-nft>

  <!-- VENT -->
  <a-nft id="m_vent" type="nft" url="markers/vent">
    <a-entity id="vent" gltf-model="models/vent/scene.gltf"
      scale="0.40 0.40 0.40" visible="false"></a-entity>
  </a-nft>

  <!-- DOOR -->
  <a-nft id="m_door" type="nft" url="markers/door">
    <a-entity id="door" gltf-model="models/door/scene.gltf"
      scale="1 1 1" visible="false"></a-entity>
  </a-nft>

  <!-- RADIO (secret branch) -->
  <a-nft id="m_radio" type="nft" url="markers/radio">
    <a-entity id="radio" gltf-model="models/radio/scene.gltf"
      scale="0.4 0.4 0.4" visible="false"></a-entity>
  </a-nft>

  <a-entity camera></a-entity>
</a-scene>

<script>
/* -----------------------------
   STATE
------------------------------ */

let state = "start";
let fuseOn = false;
let notebookChoice = null;   
let keyFound = false;
let ventOpen = false;
let radioTuned = false;

let timer = 0;
let timerInterval = null;
let lockerCode = "4729";     
let codeTimerInterval = null;
let timeLeft = 10;
let notebookRead = false;


/* -----------------------------
   HELPERS
------------------------------ */

function debug(msg){
  document.getElementById("debugMobile").innerText = "DEBUG: " + msg;
}
function hint(msg){
  document.getElementById("hintBox").innerText = msg;
}
function showButtons(...btns){
  const box = document.getElementById("uiButtons");
  box.innerHTML = "";
  btns.forEach(b => box.appendChild(b));
}
function clearButtons(){
  document.getElementById("uiButtons").innerHTML = "";
}

/* -----------------------------
   TIMER
------------------------------ */
function startTimer(seconds, onEnd){
  const box = document.getElementById("timerBox");
  timer = seconds;
  box.style.display = "block";
  box.innerText = timer;

  timerInterval = setInterval(()=>{
    timer--;
    box.innerText = timer;
    if(timer <= 0){
      clearInterval(timerInterval);
      box.style.display = "none";
      onEnd();
    }
  },1000);
}

function stopTimer() {
  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }
}


function gameOver(reason="") {
  clearButtons();
  hint(reason);
  setTimeout(() => {
    document.getElementById("gameOverScreen").style.display = "flex";
  }, 1200);
}

function win(message="You escaped.") {
  clearButtons();
  hint(message);
  setTimeout(() => {
    document.getElementById("winScreen").style.display = "flex";
  }, 1200);
}

AFRAME.registerComponent('center-model', {
  init: function () {
    this.el.addEventListener('model-loaded', () => {
      const obj = this.el.getObject3D('mesh');
      if (!obj) return;

      // Compute bounding box
      const box = new THREE.Box3().setFromObject(obj);
      const center = box.getCenter(new THREE.Vector3());
      const size = box.getSize(new THREE.Vector3());

      // Recenter the model
      obj.position.sub(center);

      // OPTIONAL: flip axes depending on rotation issues
      // obj.rotation.set(-Math.PI/2, 0, 0);  // if needed

      console.log("Model centered:", center, "size:", size);
    });
  }
});



/* -----------------------------
   MARKERS
------------------------------ */

const M = {
  flash: m_flashlight,
  fuse: m_fusebox,
  note: m_notebook,
  locker: m_locker,
  vent: m_vent,
  door: m_door,
  radio: m_radio
};

const E = {
  flash: flashlight,
  fuse: fusebox,
  note: notebook,
  locker: locker,
  vent: vent,
  door: door,
  radio: radio
};

function openCodeUI() {
  const ui = document.getElementById("codeUI");
  const timerEl = document.getElementById("codeTimer");
  const input = document.getElementById("codeInput");
  const msg = document.getElementById("codeMessage");

  input.value = "";
  ui.style.display = "block";
  timeLeft = 10;
  timerEl.innerText = `${timeLeft}s remaining`;

  codeTimerInterval = setInterval(() => {
    timeLeft--;
    timerEl.innerText = `${timeLeft}s remaining`;

    if (timeLeft <= 0) {
      clearInterval(codeTimerInterval);
      gameOver("You hesitated too long… the lock mechanism jammed forever.");
      setTimeout(() => ui.style.display = "none", 1500);
    }
  }, 1000);

  document.getElementById("codeSubmit").onclick = () => {
    if (input.value === lockerCode) {
      clearInterval(codeTimerInterval);
      stopTimer();
      ui.style.display = "none";

      keyFound = true;
      hint("A cold metal key falls to the floor…");

    } else {
      msg.innerText = "The lock rattles… wrong code.";
    }
  };

}


/* -----------------------------
   FLASHLIGHT
------------------------------ */
M.flash.addEventListener("markerFound",()=>{
  E.flash.setAttribute("visible",true);
  if(state==="start"){
    state="flashlight";
    hint("Your flashlight flickers on. You hear a faint electrical hum nearby.");
  }
});
M.flash.addEventListener("markerLost",()=>E.flash.setAttribute("visible",false));

/* -----------------------------
   FUSE BOX
------------------------------ */
M.fuse.addEventListener("markerFound",()=>{
  E.fuse.setAttribute("visible",true);

  if(state!=="flashlight"){
    hint("You grope in darkness… the fusebox feels cold.");
    return;
  }

  if(!fuseOn){
    fuseOn=true;
    hint("A soft hum fills the basement… pages may now be readable.");
    state="fuse";
  }
});
M.fuse.addEventListener("markerLost",()=>E.fuse.setAttribute("visible",false));

/* -----------------------------
   NOTEBOOK — reveals code
------------------------------ */
M.note.addEventListener("markerFound", () => {
  E.note.setAttribute("visible", true);

  if (!fuseOn) {
    hint("The ink runs in the dark… you see nothing.");
    return;
  }

  if (!notebookRead) {
    notebookRead = true;
    state = "notebook_done";

    // More subtle clue
    hint("A scribbled line reads: 'Four shadows… 4 7 2 9'. Perhaps it opens something metal.");

   clearButtons();

    // Locker path
    const btn1 = document.createElement("button");
    btn1.innerText = "Follow the Numbers";
    btn1.onclick = () => {
      notebookChoice = "locker";
      hint("The numbers echo faintly… a metal lock awaits.");
      clearButtons();
    };

    // Radio path
    const btn2 = document.createElement("button");
    btn2.innerText = "Follow the Signal";
    btn2.onclick = () => {
      notebookChoice = "radio";
      hint("A hidden broadcast calls to you…");
      clearButtons();
    };

    showButtons(btn1, btn2);
  }
});
M.note.addEventListener("markerLost",()=>E.note.setAttribute("visible",false));




/* -----------------------------
   LOCKER — requires code
------------------------------ */
M.locker.addEventListener("markerFound", () => {
  E.locker.setAttribute("visible", true);

  if(notebookChoice === null){
    hint("A rusted door… no ideas come to mind.");
    return;
  }
  if (notebookChoice === "radio") {
    gameOver("Looks like the locker was never meant for you.");
    return;
  }

  if(!keyFound){
    hint("The digits from the notebook pulse in your thoughts…");

    const b = document.createElement("button");
    b.innerText = "Enter Code";
    b.onclick = () => {
      clearButtons();
      openCodeUI();
    };

    showButtons(b);
  }
});
M.locker.addEventListener("markerLost",()=>E.locker.setAttribute("visible",false));


/* -----------------------------
   RADIO — only if chosen path
------------------------------ */
let freq = 90;
const radioSlider = document.getElementById("radioSlider");

M.radio.addEventListener("markerFound", () => {
  E.radio.setAttribute("visible", true);

  // wrong branch = instant dead end
  if (notebookChoice === "locker") {
    gameOver("You followed the wrong path… the signal swallows you.");
    return;
  }

  if (notebookChoice === null) {
    hint("Only static responds.");
    return;
  }

  // Enable slider tuning
  radioSlider.style.display = "block";
  hint("Tune the radio… find the clear frequency.");

  radioSlider.oninput = () => {
    freq = parseInt(radioSlider.value);

    if (freq >= 103 && freq <= 107) {
      radioTuned = true;
      radioSlider.style.display = "none";
      hint("A whisper breaks through: 'THE EXIT OPENS…'");
      clearButtons();
    } else {
      hint("Static: " + freq + " MHz");
    }
  };
});

M.radio.addEventListener("markerLost", () => {
  E.radio.setAttribute("visible", false);
  radioSlider.style.display = "none";
});

/* -----------------------------
   VENT (backup escape)
------------------------------ */
M.vent.addEventListener("markerFound",()=>{
  E.vent.setAttribute("visible",true);

  if(keyFound || radioTuned){
    if(!ventOpen){
      ventOpen = true;
      hint("The screws fall out… the vent is open.");
    }
  } else {
    hint("The vent is secured… not yet.");
  }
});
M.vent.addEventListener("markerLost",()=>E.vent.setAttribute("visible",false));

/* -----------------------------
   DOOR — Multiple Endings
------------------------------ */
M.door.addEventListener("markerFound",()=>{
  E.door.setAttribute("visible",true);

  if(!fuseOn){
    hint("No power reaches the mechanism…");
    return;
  }

  // RADIO END
  if(radioTuned){
    win("The door unlocks on its own… the signal guided you out.");
    return;

  }

  // LOCKER END
  if(keyFound){
    const b = document.createElement("button");
    b.innerText = "Use Key";
    b.onclick = () => {
      win("The lock snaps open… you slip into freedom.");
    };
    showButtons(b);
    return;
  }

  // VENT END
  if(ventOpen){
    win("You crawl through the open vent and escape.");
    return;


  }

  gameOver("You reached the door without the means to open it…");
});
M.door.addEventListener("markerLost",()=>E.door.setAttribute("visible",false));

</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>The Basement Inventory — AR Escape</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />

  <!-- A-Frame (latest stable) -->
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>

  <!-- AR.js NFT build (REQUIRED for NFT markers) -->
<script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>

  <style>
    body { margin:0; overflow:hidden; background:black; }
    #hintBox {
      position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
      background:rgba(0,0,0,0.75); color:#eee; padding:10px 15px;
      border-radius:10px; max-width:320px; text-align:center;
      font-family:system-ui; font-size:14px; z-index:9999;
      transition: opacity 0.6s ease;
    }
    #debugMobile {
      position:fixed; top:10px; left:10px;
      background:rgba(0,0,0,0.6); color:white;
      padding:8px; font-size:14px; z-index:99999;
    }
  </style>
</head>

<body>
<div id="debugMobile">DEBUG: none</div>
<div id="hintBox">The basement waits. Seek the Flashlight marker.</div>

<a-scene
  vr-mode-ui="enabled: false"
  embedded
  arjs="trackingMethod: best; debugUIEnabled: true;"
>
  <a-entity light="type: ambient; intensity: 0.8"></a-entity>
  <a-entity light="type: directional; intensity: 0.6" position="0 1 1"></a-entity>

  <!-- FLASHLIGHT MARKER -->
  <a-nft
    id="m_flashlight"
    type="nft"
    url="markers/flashlight">
      <a-entity id="flashlight" gltf-model="models/flashlight/scene.gltf"
        scale="0.3 0.3 0.3" visible="false">
      </a-entity>
  </a-nft>

  <!-- FUSE BOX -->
  <a-nft id="m_fusebox" type="nft" url="markers/fuse_box">
    <a-entity id="fusebox" gltf-model="models/fusebox/scene.gltf"
      scale="0.35 0.35 0.35" visible="false">
    </a-entity>
  </a-nft>

  <!-- NOTEBOOK -->
  <a-nft id="m_notebook" type="nft" url="markers/notebook">
    <a-entity id="notebook" gltf-model="models/notebook/scene.gltf"
      scale="0.35 0.35 0.35" visible="false">
    </a-entity>
  </a-nft>

  <!-- LOCKER -->
  <a-nft id="m_locker" type="nft" url="markers/locker">
    <a-entity id="locker" gltf-model="models/rusty_locker/scene.gltf"
      scale="0.5 0.5 0.5" visible="false">
    </a-entity>
  </a-nft>

  <!-- VENT -->
  <a-nft id="m_vent" type="nft" url="markers/vent">
    <a-entity id="vent" gltf-model="models/vent/scene.gltf"
      scale="0.45 0.45 0.45" visible="false">
    </a-entity>
  </a-nft>

  <!-- DOOR -->
  <a-nft id="m_door" type="nft" url="markers/door">
    <a-entity id="door" gltf-model="models/door/scene.gltf"
      scale="1 1 1" visible="false">
    </a-entity>
  </a-nft>

  <a-entity camera></a-entity>
</a-scene>

<script>
/* -----------------------------
   GAME STATE
------------------------------ */

let state = "start";
let fuseSolved = false;
let notebookRead = false;
let lockerOpened = false;
let ventOpened = false;

function debug(msg){
  document.getElementById("debugMobile").innerText = "DEBUG: " + msg;
}

function hint(msg){
  const box = document.getElementById("hintBox");
  box.innerText = msg;
  box.style.opacity = 1;
}

/* -----------------------------
   MARKER REFERENCES
------------------------------ */
const M = {
  flash: document.querySelector("#m_flashlight"),
  fuse: document.querySelector("#m_fusebox"),
  note: document.querySelector("#m_notebook"),
  locker: document.querySelector("#m_locker"),
  vent: document.querySelector("#m_vent"),
  door: document.querySelector("#m_door")
};

const Models = {
  flash: document.querySelector("#flashlight"),
  fuse: document.querySelector("#fusebox"),
  note: document.querySelector("#notebook"),
  locker: document.querySelector("#locker"),
  vent: document.querySelector("#vent"),
  door: document.querySelector("#door"),
};

/* -----------------------------
   FLASHLIGHT
------------------------------ */
M.flash.addEventListener("markerFound", () => {
  debug("FLASHLIGHT FOUND");
  Models.flash.setAttribute("visible", true);

  if(state === "start"){
    state = "flashlight";
    hint("You found the flashlight… Now look for the Fuse Box marker.");
  }
});
M.flash.addEventListener("markerLost", () => Models.flash.setAttribute("visible", false));

/* -----------------------------
   FUSE BOX
------------------------------ */
M.fuse.addEventListener("markerFound", () => {
  Models.fuse.setAttribute("visible", true);

  if(state !== "flashlight"){
    hint("The power is dead… You must find the Flashlight first.");
    return;
  }

  if(!fuseSolved){
    fuseSolved = true;
    state = "fuse";
    hint("Power hums back. Seek the Notebook marker.");
  }
});
M.fuse.addEventListener("markerLost", () => Models.fuse.setAttribute("visible", false));

/* -----------------------------
   NOTEBOOK
------------------------------ */
M.note.addEventListener("markerFound", () => {
  Models.note.setAttribute("visible", true);

  if(!fuseSolved){
    hint("The notebook is unreadable in the dark… Fix the Fuse Box first.");
    return;
  }

  if(!notebookRead){
    notebookRead = true;
    state = "note";
    hint("The notebook reveals a code… Check the Locker marker.");
  }
});
M.note.addEventListener("markerLost", () => Models.note.setAttribute("visible", false));

/* -----------------------------
   LOCKER
------------------------------ */
M.locker.addEventListener("markerFound", () => {
  Models.locker.setAttribute("visible", true);

  if(!notebookRead){
    hint("A lock blocks your way… The Notebook holds the clue.");
    return;
  }

  if(!lockerOpened){
    lockerOpened = true;
    state = "locker";
    hint("You found a cold metal key. Try the Exit Door marker.");
  }
});
M.locker.addEventListener("markerLost", () => Models.locker.setAttribute("visible", false));

/* -----------------------------
   VENT
------------------------------ */
M.vent.addEventListener("markerFound", () => {
  Models.vent.setAttribute("visible", true);

  if(!lockerOpened){
    hint("The vent won’t budge… Something else must be unlocked first.");
    return;
  }

  if(!ventOpened){
    ventOpened = true;
    state = "vent";
    hint("A hidden escape route opens… Perhaps the Door is not needed.");
  }
});
M.vent.addEventListener("markerLost", () => Models.vent.setAttribute("visible", false));

/* -----------------------------
   DOOR
------------------------------ */
M.door.addEventListener("markerFound", () => {
  Models.door.setAttribute("visible", true);

  if(!fuseSolved){
    hint("The door refuses to power on… Restore electricity first.");
    return;
  }

  if(lockerOpened){
    state = "escaped";
    hint("The key turns… The door unlocks. You escape the basement.");
    return;
  }

  if(ventOpened){
    state = "escaped";
    hint("The door stays sealed… but the vent is your freedom.");
    return;
  }

  hint("The door is locked tight… Something crucial is still missing.");
});
M.door.addEventListener("markerLost", () => Models.door.setAttribute("visible", false));

</script>
</body>
</html>

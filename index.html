<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>The Basement Inventory — AR Escape</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <!-- AR.js -->
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>

  <style>
    body { margin:0; overflow:hidden; background:black; }
    #hintBox {
      position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
      background:rgba(0,0,0,0.75); color:#eee; padding:10px 15px;
      border-radius:10px; max-width:320px; text-align:center;
      font-family:system-ui; font-size:14px; z-index:9999;
      transition: opacity 0.6s ease;
    }
  </style>
</head>

<body>
  <div id="debugMobile"
     style="position:fixed; top:10px; left:10px; 
            background:rgba(0,0,0,0.6); color:white; 
            padding:8px; font-size:14px; z-index:99999;">
    DEBUG: none
</div>


<!-- HINT BOX -->
<div id="hintBox">The basement waits. Seek the Flashlight marker.</div>

<a-scene
  embedded
  renderer="colorManagement: true; physicallyCorrectLights: true"
  xr-mode-ui="enabled: false"
  arjs="sourceType: webcam; detectionMode: mono; debugUIEnabled: false">

  <a-entity light="type: ambient; intensity: 0.8"></a-entity>
  <a-entity light="type: directional; intensity: 0.6" position="0 1 1"></a-entity>

  <!-- --------------------------- MARKERS --------------------------- -->

  <!-- Marker 1 — Flashlight -->
  <a-nft type="nft" id="m_flashlight" url="./markers/flashlight">
     <a-entity id="flashlight" gltf-model="./models/flashlight/scene.gltf"
      scale="0.3 0.3 0.3" rotation="0 0 0" visible="false">
    </a-entity>
    </a-nft>

  <!-- Marker 2 — Fuse Box -->
  <a-nft type="nft" id="m_fusebox" url="./markers/fuse_box">
    <a-entity id="fusebox" gltf-model="./models/fusebox/scene.gltf"
      scale="0.4 0.4 0.4" rotation="0 180 0" visible="false">
    </a-entity>
  </a-nft>

  <!-- Marker 3 — Notebook -->
  <a-nft type="nft" id="m_notebook" url="./markers/notebook">
 <a-entity id="notebook" gltf-model="./models/notebook/scene.gltf"
      scale="0.35 0.35 0.35" visible="false">
    </a-entity>
  </a-nft>

  <!-- Marker 4 — Locker -->
  <a-nft type="nft" id="m_locker" url="./markers/locker">
    <a-entity id="locker" gltf-model="./models/rusty_locker/scene.gltf"
      scale="0.5 0.5 0.5" rotation="0 90 0" visible="false">
    </a-entity>
  </a-nft>

  <!-- Marker 5 — Vent -->
  <a-nft type="nft" id="m_vent" url="./markers/vent">
    <a-entity id="vent" gltf-model="./models/vent/scene.gltf"
      scale="0.5 0.5 0.5" rotation="0 0 0" visible="false">
    </a-entity>
  </a-nft>

  <!-- Marker 6 — Exit Door -->
  <a-nft type="nft" id="m_door" url="./markers/door">
<a-entity id="door" gltf-model="./models/door/scene.gltf"
      scale="1 1 1" rotation="0 0 0" visible="false">
    </a-entity>
  </a-nft>

  <a-entity camera></a-entity>
</a-scene>

<script>
/* -------------------------------------------------
   MYSTERIOUS ESCAPE PUZZLE — STATE MACHINE
--------------------------------------------------- */

let state = "start";
let fuseSolved = false;
let notebookRead = false;
let lockerOpened = false;
let ventOpened = false;

const flashMarker = document.querySelector('#m-flashlight');
const flashModel  = document.querySelector('#flashlight');

flashMarker.addEventListener('markerFound', () => {
    debug("FLASHLIGHT FOUND");
    flashModel.setAttribute('visible', true);
});

flashMarker.addEventListener('markerLost', () => {
    debug("FLASHLIGHT LOST");
    flashModel.setAttribute('visible', false);
});

function hint(msg) {
  const box = document.getElementById("hintBox");
  box.innerText = msg;
  box.style.opacity = 1;
  setTimeout(() => { box.style.opacity = 0.6; }, 6000);
}

const M = {
  flash: document.querySelector("#m_flashlight"),
  fuse: document.querySelector("#m_fusebox"),
  note: document.querySelector("#m_notebook"),
  locker: document.querySelector("#m_locker"),
  vent: document.querySelector("#m_vent"),
  door: document.querySelector("#m_door"),
};

/* ------------------ Flashlight ------------------ */
M.flash.addEventListener("markerFound", () => {
  flashlight.setAttribute("visible", true);

  if (state === "start") {
    state = "flashlight";
    hint("The light stirs… Seek the Fuse Box marker.");
  }
});

/* ------------------ Fuse Box ------------------ */
M.fuse.addEventListener("markerFound", () => {
  fusebox.setAttribute("visible", true);

  if (state !== "flashlight") {
    hint("The room is silent. The Flashlight must awaken first.");
    return;
  }

  if (!fuseSolved) {
    fuseSolved = true;
    state = "fuse";
    hint("A faint hum returns. Now look for the Notebook marker.");
  }
});

/* ------------------ Notebook ------------------ */
M.note.addEventListener("markerFound", () => {
  notebook.setAttribute("visible", true);

  if (!fuseSolved) {
    hint("The pages whisper, but power must return first.");
    return;
  }

  if (!notebookRead) {
    notebookRead = true;
    state = "note";
    hint("A torn code appears… The Locker marker may reveal more.");
  }
});

/* ------------------ Locker ------------------ */
M.locker.addEventListener("markerFound", () => {
  locker.setAttribute("visible", true);

  if (!notebookRead) {
    hint("The lock resists. Something in the Notebook must guide you.");
    return;
  }

  if (!lockerOpened) {
    lockerOpened = true;
    state = "locker";
    hint("Inside lies a cold metal key. Some doors open, some deceive… Try the Exit Door marker.");
  }
});

/* ------------------ Vent ------------------ */
M.vent.addEventListener("markerFound", () => {
  vent.setAttribute("visible", true);

  if (!lockerOpened) {
    hint("The grate won’t budge. Perhaps another path must be earned first.");
    return;
  }

  if (!ventOpened) {
    ventOpened = true;
    state = "vent";
    hint("A narrow escape reveals itself. If the Door denies you… the vent may not.");
  }
});

/* ------------------ Exit Door ------------------ */
M.door.addEventListener("markerFound", () => {
  door.setAttribute("visible", true);

  if (!fuseSolved) {
    hint("The lock lies dormant. The room must breathe first.");
    return;
  }

  if (lockerOpened) {
    state = "escaped";
    hint("The key turns. The way out welcomes you.");
    return;
  }

  if (ventOpened) {
    state = "escaped";
    hint("The door stays silent… but the vent is enough. You escape into the unknown.");
    return;
  }

  hint("The door refuses you. Something important remains hidden.");
});

function debug(msg){
    document.getElementById('debugMobile').innerText = "DEBUG: " + msg;
}

</script>
</body>
</html>
